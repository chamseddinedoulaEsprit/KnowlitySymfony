{% extends 'base2.html.twig' %}


{% block stylesheet %}
    <head>
  <!-- Google Font: Source Sans Pro -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="{{ asset('assets/plugins/fontawesome-free/css/all.min.css') }}">
  <!-- DataTables -->
  <link rel="stylesheet" href="{{ asset('plugins/datatables-bs4/css/dataTables.bootstrap4.min.css') }}">
  <link rel="stylesheet" href="{{ asset('plugins/datatables-responsive/css/responsive.bootstrap4.min.css') }}">
  <link rel="stylesheet" href="{{ asset('plugins/datatables-buttons/css/buttons.bootstrap4.min.css') }}">
  <link rel="stylesheet" href="{{ asset('plugins/sweetalert2-theme-bootstrap-4/bootstrap-4.min.css') }}">
  <link rel="stylesheet" href="{{ asset('plugins/toastr/toastr.min.css') }}">
  <link rel="stylesheet" href="{{ asset('dist/css/adminlte.min.css') }}">
    </head>
{% endblock %}

{% block body %}


    <input type="text" id="searchInput" placeholder="Search events..." />

<table id="eventsTable">
    <thead>
        <tr>
            <th>Title</th>
            <th>Image</th>
            <th>Description</th>
            <th>Start Date</th>
            <th>End Date</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody id="eventsBody">
    {% for event in event %}
        <tr>
            <td>{{ event.title }}</td>
            <td><img src="{{ asset('uploads/events/' ~ event.image) }}" alt="{{ event.title }}" style="width: 2cm; height: auto;"></td>
            <td>{{ event.description }}</td>
            <td>{{ event.startDate|date('Y-m-d H:i') }}</td>
            <td>{{ event.endDate|date('Y-m-d H:i') }}</td>
            <td>
                <button type="button" class="btn btn-block btn-info">
                    <a href="{{ path('app_admin_events_edit', {'id': event.id}) }}" style="color: inherit; text-decoration: none;">Edit</a>
                </button>
                <button type="button" class="btn btn-danger" data-toggle="modal" data-target="#modal-danger-{{ event.id }}">
                    Delete
                </button>
                <div class="modal fade" id="modal-danger-{{ event.id }}">
                    <div class="modal-dialog">
                        <div class="modal-content bg-danger">
                            <div class="modal-header">
                                <h4 class="modal-title">Confirm Deletion</h4>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <p>Are you sure you want to delete this event?</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-outline-light" data-dismiss="modal">Close</button>
                                <form id="delete-form-{{ event.id }}" action="{{ path('app_admin_events_delete', {'id': event.id}) }}" method="post" style="display: none;">
                                    <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ event.id) }}">
                                </form>
                                <button type="button" class="btn btn-outline-light" onclick="document.getElementById('delete-form-{{ event.id }}').submit();">
                                    Confirm
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </td>
        </tr>
    {% else %}
        <tr>
            <td colspan="6">No events found.</td>
        </tr>
    {% endfor %}
</tbody>
</table>




      <div class="modal fade" id="modal-overlay">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="overlay">
                <i class="fas fa-2x fa-sync fa-spin"></i>
            </div>
            <div class="modal-header">
              <h4 class="modal-title">Default Modal</h4>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <p>One fine body&hellip;</p>
            </div>
            <div class="modal-footer justify-content-between">
              <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
              <button type="button" class="btn btn-primary">Save changes</button>
            </div>
          </div>
          <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
      </div>
      <!-- /.modal -->

{% endblock %}

{% block script %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.30/jspdf.plugin.autotable.min.js"></script>

   <script src="{{ asset('plugins/jquery/jquery.min.js') }}"></script>
    <script src="{{ asset('plugins/bootstrap/js/bootstrap.bundle.min.js') }}"></script>
    <script src="{{ asset('plugins/datatables/jquery.dataTables.min.js') }}"></script>
    <script src="{{ asset('plugins/datatables-bs4/js/dataTables.bootstrap4.min.js') }}"></script>
    <script src="{{ asset('plugins/datatables-responsive/js/dataTables.responsive.min.js') }}"></script>
    <script src="{{ asset('plugins/datatables-responsive/js/responsive.bootstrap4.min.js') }}"></script>
    <script src="{{ asset('plugins/datatables-buttons/js/dataTables.buttons.min.js') }}"></script>
    <script src="{{ asset('plugins/datatables-buttons/js/buttons.bootstrap4.min.js') }}"></script>
    <script src="{{ asset('plugins/jszip/jszip.min.js') }}"></script>
    <script src="{{ asset('plugins/pdfmake/pdfmake.min.js') }}"></script>
    <script src="{{ asset('plugins/pdfmake/vfs_fonts.js') }}"></script>
    <script src="{{ asset('plugins/datatables-buttons/js/buttons.html5.min.js') }}"></script>
    <script src="{{ asset('plugins/datatables-buttons/js/buttons.print.min.js') }}"></script>
    <script src="{{ asset('plugins/datatables-buttons/js/buttons.colVis.min.js') }}"></script>
    <script src="{{ asset('dist/js/adminlte.min.js') }}"></script>
    <script src="{{ asset('dist/js/demo.js') }}"></script>
    <script src="{{ asset('plugins/sweetalert2/sweetalert2.min.js') }}"></script>
    <script src="{{ asset('plugins/toastr/toastr.min.js') }}"></script>

    
<script>
document.getElementById('searchInput').addEventListener('input', function() {
    let query = this.value;

    fetch(`/admin/events/search?q=${query}`)
        .then(response => response.json())
        .then(events => {
            let tableBody = document.getElementById('eventsBody');
            tableBody.innerHTML = '';

            if (events.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6">No events found.</td></tr>`;
                return;
            }

            events.forEach(event => {
                let shortDescription = event.description.length > 20 ? event.description.substring(0, 20) + '...' : event.description;
                let row = `<tr style="border-bottom: 1px solid #ddd; text-align: center;">
                    <td style="padding: 10px;">${event.title}</td>
                    <td style="padding: 10px;"><img src="/uploads/events/${event.image}" alt="${event.title}" style="width: 2cm; height: auto; border-radius: 5px;"></td>
                    <td style="padding: 10px;">${shortDescription}</td>
                    <td style="padding: 10px;">${event.startDate}</td>
                    <td style="padding: 10px;">${event.endDate}</td>
                    <td style="padding: 10px;">
                        <button type="button" class="btn btn-info">
                            <a href="/admin/events/${event.id}/edit" style="color: inherit; text-decoration: none;">Edit</a>
                        </button>
                        <button type="button" class="btn btn-danger" data-toggle="modal" data-target="#modal-danger-${event.id}">
                            Delete
                        </button>

                        <div class="modal fade" id="modal-danger-${event.id}">
                            <div class="modal-dialog">
                                <div class="modal-content bg-danger">
                                    <div class="modal-header">
                                        <h4 class="modal-title">Delete Confirmation</h4>
                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                            <span aria-hidden="true">&times;</span>
                                        </button>
                                    </div>
                                    <div class="modal-body">
                                        <p>Are you sure you want to delete event ID: ${event.id}?</p>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-outline-light" data-dismiss="modal">Close</button>
                                        <button type="button" class="btn btn-outline-light" onclick="deleteEvent(${event.id})">
                                            Confirm
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>`;
                tableBody.innerHTML += row;
            });
        });
});

function downloadPDF() {
    const { jsPDF } = window.jspdf; // Get jsPDF from the global window object
    let doc = new jsPDF();

    doc.text("Event List", 14, 10);
    let table = document.getElementById("eventsTable");
    let rows = [];

    for (let i = 1; i < table.rows.length; i++) {
        let row = [];
        for (let j = 0; j < table.rows[i].cells.length - 1; j++) { // Exclude action column
            row.push(table.rows[i].cells[j].innerText);
        }
        rows.push(row);
    }

    doc.autoTable({
        head: [["Title","" ,"Description", "Start Date", "End Date"]],
        body: rows,
    });

    doc.save("events.pdf");
}


document.addEventListener("DOMContentLoaded", function() {
    let downloadButton = document.createElement("button");
    downloadButton.innerText = "Download PDF";
    downloadButton.classList.add("btn", "btn-success");
    downloadButton.style.marginBottom = "10px";
    downloadButton.onclick = downloadPDF;
    document.getElementById("eventsTable").parentNode.insertBefore(downloadButton, document.getElementById("eventsTable"));
});


function deleteEvent(eventId) {
    fetch(`/admin/events/delete/${eventId}`, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json',
            'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
        }
    }).then(response => {
        if (response.ok) {
            document.getElementById('searchInput').dispatchEvent(new Event('input'));
            alert("Event deleted successfully.");
        } else {
            alert("Failed to delete event.");
        }
    });
}
</script>


{% endblock %}

    